#!/bin/bash

CREDS=$(cat ~/.sptf-creds.json)

CLIENT_ID=$(echo $CREDS | jq -r '.client_id')
CLIENT_SECRET=$(echo $CREDS | jq -r '.client_secret')

getRefreshToken() {
    echo $CREDS | jq -r '.refresh'
}

getAccessToken() {
    echo $CREDS | jq -r '.access'
}

b64() {
    echo -n "$1" | base64
}

refresh() {
    auth=$(b64 "$CLIENT_ID:$CLIENT_SECRET")
    refresh=$(getRefreshToken)
    curl --request POST \
         --url https://accounts.spotify.com/api/token \
         --header "authorization: Basic $auth" \
         -d "grant_type=refresh_token&refresh_token=$refresh" \
         -sS
}

refreshAndSave() {
    >&2 echo 'refreshing token'
    >&2 echo "$1"
    token=$(refresh | jq -r '.access_token')
    cat ~/.sptf-creds.json  | jq -r "setpath([\"access\"]; \"$token\")" > /tmp/sptf-creds.json
    cat /tmp/sptf-creds.json > ~/.sptf-creds.json
}

_request() {
    access=$(getAccessToken)
    >&2 echo "$1" "$2" "$3"
    if [ -z "$3" ]; then
        curl --request $1 \
             --url https://api.spotify.com/v1/$2 \
             --header "authorization: Bearer $access" \
             --header "accept: application/json" \
             -sS
    else
        curl --request $1 \
             --url https://api.spotify.com/v1/$2 \
             --header "authorization: Bearer $access" \
             --header "accept: application/json" \
             -d "$3" \
             -sS
    fi
}

request() {
    result=$(_request "$1" "$2" "$3")

    if [ -z "$result" ]; then
        echo "$result"
    else
        error=$(echo "$result" | jq -re '.error.message | tostring')

        if [[ "$error" == "null" ]]; then
            echo "$result"
        else
            refreshAndSave "$result"
            _request "$1" "$2" "$3"
        fi
    fi
}

getInfo() {
    request GET "me/player/currently-playing"
}

getTrackId() {
    echo $(getInfo) | jq -r '.item.id'
}

saveToLibrary() {
    id=$(getTrackId)
    request PUT "me/tracks" "{\"ids\": [\"$id\"]}"
}

case $1 in
    info)
        getInfo
        ;;
    save)
        saveToLibrary
        ;;
    to-month)
        saveToMonthList
        ;;
    request)
        request "$2" "$3" "$4"
        ;;
    *)
        echo $1
        ;;
esac
